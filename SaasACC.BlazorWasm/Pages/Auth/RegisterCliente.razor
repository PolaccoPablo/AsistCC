@page "/register/cliente"
@using MudBlazor
@using SaacACC.BlazorWasm.Services
@using SaasACC.BlazorWasm.Layout
@using SaasACC.Model.Servicios.Login
@using System.Net.Http.Json
@layout EmptyLayout
@inject IAuthService AuthService
@inject HttpClient HttpClient
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Medium" Class="d-flex align-center" Style="min-height: 100vh; padding: 2rem 0;">
    <MudPaper Class="pa-8 mx-auto" Elevation="3" Style="width: 100%;">
        <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-2">
            Registrar Cliente
        </MudText>
        <MudText Typo="Typo.body2" Align="Align.Center" Class="mb-6" Color="Color.Default">
            Crea tu cuenta de cliente y accede a tu cuenta corriente
        </MudText>

        @if (loadingComercios)
        {
            <MudProgressLinear Indeterminate="true" Class="mb-4" />
        }
        else
        {
            <MudForm @ref="form" @bind-IsValid="@success">
                <MudText Typo="Typo.h6" Class="mb-3 mt-4">Selecciona tu Comercio</MudText>

                <MudSelect @bind-Value="model.ComercioId"
                          Label="Comercio"
                          Variant="Variant.Outlined"
                          Required="true"
                          RequiredError="Debe seleccionar un comercio"
                          Class="mb-4">
                    @foreach (var comercio in comercios)
                    {
                        <MudSelectItem Value="@comercio.Id">
                            @comercio.Nombre - @comercio.Email
                        </MudSelectItem>
                    }
                </MudSelect>

                <MudDivider Class="my-4" />

                <MudText Typo="Typo.h6" Class="mb-3">Tus Datos</MudText>

                <MudTextField @bind-Value="model.Nombre"
                             Label="Nombre"
                             Variant="Variant.Outlined"
                             Required="true"
                             RequiredError="El nombre es requerido"
                             Class="mb-3" />

                <MudTextField @bind-Value="model.Apellido"
                             Label="Apellido"
                             Variant="Variant.Outlined"
                             Required="true"
                             RequiredError="El apellido es requerido"
                             Class="mb-3" />

                <MudTextField @bind-Value="model.Email"
                             Label="Email"
                             Variant="Variant.Outlined"
                             Required="true"
                             RequiredError="El email es requerido"
                             InputType="InputType.Email"
                             Class="mb-3" />

                <MudTextField @bind-Value="model.Telefono"
                             Label="Teléfono"
                             Variant="Variant.Outlined"
                             Required="true"
                             RequiredError="El teléfono es requerido"
                             InputType="InputType.Telephone"
                             Class="mb-3" />

                <MudTextField @bind-Value="model.DNI"
                             Label="DNI (opcional)"
                             Variant="Variant.Outlined"
                             Class="mb-3" />

                <MudTextField @bind-Value="model.Direccion"
                             Label="Dirección (opcional)"
                             Variant="Variant.Outlined"
                             Lines="2"
                             Class="mb-3" />

                <MudDivider Class="my-4" />

                <MudText Typo="Typo.h6" Class="mb-3">Credenciales de Acceso</MudText>

                <MudTextField @bind-Value="model.Password"
                             Label="Contraseña"
                             Variant="Variant.Outlined"
                             Required="true"
                             RequiredError="La contraseña es requerida"
                             InputType="InputType.Password"
                             Class="mb-3" />

                <MudTextField @bind-Value="model.ConfirmPassword"
                             Label="Confirmar Contraseña"
                             Variant="Variant.Outlined"
                             Required="true"
                             RequiredError="Debe confirmar la contraseña"
                             InputType="InputType.Password"
                             Class="mb-6" />

                <MudButton Variant="Variant.Filled"
                          Color="Color.Primary"
                          FullWidth="true"
                          OnClick="HandleRegister"
                          Disabled="@loading"
                          Class="py-2 mb-3">
                    @if (loading)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    }
                    Crear Cuenta
                </MudButton>

                <MudButton Variant="Variant.Text"
                          Color="Color.Default"
                          FullWidth="true"
                          OnClick="@(() => Navigation.NavigateTo("/register"))">
                    Volver
                </MudButton>
            </MudForm>
        }

        <MudDivider Class="my-4" />

        <MudText Align="Align.Center">
            ¿Ya tienes cuenta?
            <MudLink Href="/login" Color="Color.Primary">Iniciar Sesión</MudLink>
        </MudText>
    </MudPaper>
</MudContainer>

@code {
    private MudForm form = null!;
    private RegisterClienteRequest model = new();
    private bool success;
    private bool loading;
    private bool loadingComercios = true;
    private List<ComercioListItem> comercios = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadComercios();
    }

    private async Task LoadComercios()
    {
        try
        {
            var response = await HttpClient.GetFromJsonAsync<List<ComercioListItem>>("api/comercios");
            if (response != null)
            {
                comercios = response;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Error al cargar la lista de comercios", Severity.Error);
        }
        finally
        {
            loadingComercios = false;
        }
    }

    private async Task HandleRegister()
    {
        if (model.ComercioId <= 0)
        {
            Snackbar.Add("Debe seleccionar un comercio", Severity.Warning);
            return;
        }

        // Validar que la contraseña esté presente
        if (string.IsNullOrWhiteSpace(model.Password))
        {
            Snackbar.Add("La contraseña es requerida", Severity.Warning);
            return;
        }

        // Validar longitud de contraseña
        if (model.Password.Length < 6)
        {
            Snackbar.Add("La contraseña debe tener al menos 6 caracteres", Severity.Warning);
            return;
        }

        // Validar que las contraseñas coincidan
        if (model.Password != model.ConfirmPassword)
        {
            Snackbar.Add("Las contraseñas no coinciden", Severity.Warning);
            return;
        }

        loading = true;

        var result = await AuthService.RegisterCliente(model);

        if (result.Success)
        {
            Snackbar.Add("Cliente registrado exitosamente. Por favor, contacta al comercio para que active tu cuenta.", Severity.Success);
            await Task.Delay(2000);
            Navigation.NavigateTo("/login");
        }
        else
        {
            Snackbar.Add(result.ErrorMessage, Severity.Error);
        }

        loading = false;
    }

    private class ComercioListItem
    {
        public int Id { get; set; }
        public string Nombre { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public string Telefono { get; set; } = string.Empty;
    }
}
