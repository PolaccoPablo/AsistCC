@page "/change-password"
@using MudBlazor
@using SaacACC.BlazorWasm.Services
@using SaasACC.BlazorWasm.Layout
@using SaasACC.Model.Servicios.Login
@layout EmptyLayout
@inject IAuthService AuthService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<MudContainer MaxWidth="MaxWidth.Small" Class="d-flex align-center" Style="min-height: 100vh; padding: 2rem 0;">
    <MudPaper Class="pa-8 mx-auto" Elevation="3" Style="width: 100%;">
        <MudText Typo="Typo.h4" Align="Align.Center" Class="mb-2">
            Cambio de Contraseña Obligatorio
        </MudText>
        <MudText Typo="Typo.body2" Align="Align.Center" Class="mb-6" Color="Color.Warning">
            Por seguridad, debes cambiar tu contraseña temporal antes de continuar
        </MudText>

        <MudAlert Severity="Severity.Info" Class="mb-4">
            Tu contraseña temporal es tu DNI. Por favor, ingresa tu DNI en "Contraseña Actual" y luego elige una nueva contraseña segura.
        </MudAlert>

        <MudForm @ref="form" @bind-IsValid="@success">
            <MudTextField @bind-Value="model.CurrentPassword"
                         Label="Contraseña Actual (DNI)"
                         Variant="Variant.Outlined"
                         Required="true"
                         RequiredError="La contraseña actual es requerida"
                         InputType="InputType.Password"
                         Class="mb-3" />

            <MudTextField @bind-Value="model.NewPassword"
                         Label="Nueva Contraseña"
                         Variant="Variant.Outlined"
                         Required="true"
                         RequiredError="La nueva contraseña es requerida"
                         InputType="InputType.Password"
                         Class="mb-3"
                         HelperText="Mínimo 6 caracteres" />

            <MudTextField @bind-Value="model.ConfirmPassword"
                         Label="Confirmar Nueva Contraseña"
                         Variant="Variant.Outlined"
                         Required="true"
                         RequiredError="Debe confirmar la contraseña"
                         InputType="InputType.Password"
                         Class="mb-6" />

            <MudButton Variant="Variant.Filled"
                      Color="Color.Primary"
                      FullWidth="true"
                      OnClick="HandleChangePassword"
                      Disabled="@loading"
                      Class="py-2">
                @if (loading)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                }
                Cambiar Contraseña
            </MudButton>
        </MudForm>
    </MudPaper>
</MudContainer>

@code {
    private MudForm form = null!;
    private ChangePasswordRequest model = new();
    private bool success;
    private bool loading;

    private async Task HandleChangePassword()
    {
        // Validar que las contraseñas coincidan
        if (model.NewPassword != model.ConfirmPassword)
        {
            Snackbar.Add("Las contraseñas no coinciden", Severity.Warning);
            return;
        }

        // Validar longitud de contraseña
        if (model.NewPassword.Length < 6)
        {
            Snackbar.Add("La contraseña debe tener al menos 6 caracteres", Severity.Warning);
            return;
        }

        loading = true;

        var result = await AuthService.ChangePassword(model);

        if (result.Success)
        {
            Snackbar.Add("Contraseña actualizada correctamente. Redirigiendo...", Severity.Success);
            await Task.Delay(1500);
            Navigation.NavigateTo("/");
        }
        else
        {
            Snackbar.Add(result.ErrorMessage, Severity.Error);
        }

        loading = false;
    }
}
